@using ML.PCM.Menus
@using Volo.Abp.UI.Navigation
@using Volo.Abp.Users
@inject IMenuManager MenuManager
@inject ICurrentUser CurrentUser
@inject NavigationManager Navigation

<!-- 使用 Flex 布局撑满高度 -->
<div class="d-flex flex-column" style="height: 100%">

    <!-- ✅ 1. 顶部 Logo 区域 (对应问题 2) -->
    <div class="d-flex align-center pa-4">
        <!-- 替换为你自己的图标或图片 -->
        <MudIcon Icon="@Icons.Material.Filled.Polymer" Color="MudBlazor.Color.Primary" Size="MudBlazor.Size.Large" Class="mr-3" />
        <MudText Typo="Typo.h6" Style="font-weight: 700; color: var(--mud-palette-text-primary);">
            HuiXi PCM
        </MudText>
    </div>

    <!-- ============================================================== -->
    <!-- 菜单列表区域 (红色区域主体) -->
    <!-- flex-grow-1 确保它占据中间所有空间，overflow-y-auto 允许内部滚动 -->
    <!-- ============================================================== -->
    <div class="flex-grow-1 overflow-y-auto py-2">
        <MudNavMenu>
            <!-- 递归渲染 ABP 动态菜单 -->
            @if (_menu != null)
            {
                @foreach (var item in _menu.Items)
                {
                    @RenderMenuItem(item)
                }
            }
        </MudNavMenu>
    </div>

    <!-- ============================================================== -->
    <!-- 绿色区域：底部用户卡片 (固定在底部) -->
    <!-- ============================================================== -->
    <div class="mt-auto">
        <!-- mt-auto 确保它被推到底部 -->
        <MudDivider Class="my-2" Style="border-color: rgba(255,255,255,0.08);" />
        <div class="pa-2">
            <MudMenu AnchorOrigin="Origin.TopCenter" TransformOrigin="Origin.BottomCenter" FullWidth="true" LockScroll="true" PopoverClass="user-menu-popover">
                <ActivatorContent>
                    <MudPaper Width="100%" Class="d-flex align-center pa-2 cursor-pointer hover-effect" Elevation="0" Style="background: transparent;">
                        <!-- 头像 -->
                        <MudAvatar Color="MudBlazor.Color.Primary" Size="MudBlazor.Size.Medium" Variant="Variant.Filled">
                            @(_userName?.FirstOrDefault().ToString().ToUpper() ?? "U")
                        </MudAvatar>

                        <!-- 用户信息 -->
                        <div class="ml-3" style="overflow:hidden; flex-grow: 1;">
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">
                                @_userName
                            </MudText>
                            <MudText Typo="Typo.caption" Style="opacity:0.6; display:block; text-overflow:ellipsis; overflow:hidden; white-space:nowrap;">
                                @_userEmail
                            </MudText>
                            <!-- 角色/职位 (可选) -->
                            <MudText Typo="Typo.caption" Style="opacity: 0.5; font-size: 0.7rem;">
                                Admin
                            </MudText>
                        </div>

                        <MudSpacer />
                        <!-- 那个三个点的图标 -->
                        <MudIcon Icon="@Icons.Material.Filled.MoreVert" Size="MudBlazor.Size.Small" />
                    </MudPaper>
                </ActivatorContent>
                <ChildContent>
                    <MudMenuItem Href="/my-profile" Icon="@Icons.Material.Filled.Person">我的账户</MudMenuItem>
                    <MudMenuItem OnClick="BeginLogout" Icon="@Icons.Material.Filled.Logout">注销</MudMenuItem>
                </ChildContent>
            </MudMenu>
        </div>
        <!-- 版本号 (你的截图最底下有版本号) -->
        <div class="px-4 pb-2">
            <MudText Typo="Typo.caption" Style="color: var(--mud-palette-text-disabled);">
                @DateTime.Now.Year 版权所有 | 版本 1.0.0
            </MudText>
        </div>
    </div>
</div>

<style>
    /* 鼠标悬停效果 */
    .hover-effect {
        transition: background-color 0.2s;
        border-radius: 4px;
    }

        .hover-effect:hover {
            background-color: rgba(255,255,255, 0.1);
        }
</style>

@code {
    private ApplicationMenu? _menu;
    private string? _userName;
    private string? _userEmail;

    protected override async Task OnInitializedAsync()
    {
        _menu = await MenuManager.GetAsync(StandardMenus.Main);
        if (CurrentUser.IsAuthenticated)
        {
            _userName = CurrentUser.UserName;
            _userEmail = CurrentUser.Email;
        }
    }

    // 递归渲染菜单逻辑 (和之前一样，为了完整性再次列出)
    private RenderFragment RenderMenuItem(ApplicationMenuItem item) => builder =>
    {
        var icon = item.Icon;
        if (!string.IsNullOrEmpty(icon) && !icon.StartsWith("M") && !icon.StartsWith("<")) icon = Icons.Material.Filled.Circle;

        if (item.Items.Any())
        {
            builder.OpenComponent<MudNavGroup>(0);
            builder.AddAttribute(1, "Title", item.DisplayName);
            builder.AddAttribute(2, "Icon", icon);
            // 默认展开逻辑
            builder.AddAttribute(3, "Expanded", item.Name == PCMMenus.EngineeringManagement);
            builder.AddAttribute(4, "ChildContent", (RenderFragment)((b) =>
            {
                foreach (var subItem in item.Items) b.AddContent(5, RenderMenuItem(subItem));
            }));
            builder.CloseComponent();
        }
        else
        {
            builder.OpenComponent<MudNavLink>(6);
            var url = item.Url.Replace("~", "");
            builder.AddAttribute(7, "Href", url);
            builder.AddAttribute(8, "Match", NavLinkMatch.Prefix);
            builder.AddAttribute(9, "Icon", icon);
            builder.AddAttribute(10, "ChildContent", (RenderFragment)((b) => b.AddContent(11, item.DisplayName)));
            builder.CloseComponent();
        }
    };

    private void BeginLogout()
    {
        Navigation.NavigateTo("/Account/Logout", forceLoad: true);
    }
}