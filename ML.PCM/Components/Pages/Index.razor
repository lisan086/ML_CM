@page "/"
@inherits PCMComponentBase
@using ML.PCM.Services.Projects
@using ML.PCM.Services.Contracts
@using ML.PCM.Services.Dtos.Projects
@using ML.PCM.Services.Dtos.Contracts
@using Volo.Abp.Application.Dtos
@using MudBlazor

@inject IProjectAppService _projectAppService
@inject IContractAppService _contractAppService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>仪表盘</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">

    @* --- 区域一：KPI 统计卡片 --- *@
    <MudGrid Spacing="3" Class="mb-4">
        @* 1. 项目总数 *@
        <MudItem xs="12" sm="6" md="2">
            <MudCard Style="cursor: pointer" @onclick="@(() => NavigationManager.NavigateTo("/projects_main"))">
                <MudCardContent Class="text-center">
                    <MudText Typo="Typo.subtitle1">项目总数</MudText>
                    <MudText Typo="Typo.h5" Class="mud-font-bold">@_dashboardData?.ProjectCount</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        @* 2. 合同总数 *@
        <MudItem xs="12" sm="6" md="2">
            <MudCard Style="cursor: pointer" @onclick="@(() => NavigationManager.NavigateTo("/projects/contracts"))">
                <MudCardContent Class="text-center">
                    <MudText Typo="Typo.subtitle1">合同总数</MudText>
                    <MudText Typo="Typo.h5" Class="mud-font-bold">@_dashboardData?.ContractCount</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        @* 3. 合同总金额 (黑色/默认色) *@
        <MudItem xs="12" sm="6" md="2">
            <MudCard>
                <MudCardContent Class="text-center">
                    <MudText Typo="Typo.subtitle1">合同总金额</MudText>
                    @* 修改点：使用 "¥#,##0.00" 强制显示人民币符号，去除 N2 *@
                    <MudText Typo="Typo.h5" Class="mud-font-bold">
                        @(_dashboardData?.TotalContractAmount.ToString("¥#,##0.00"))
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        @* 4. 累计已付总额 (绿色文字) *@
        <MudItem xs="12" sm="6" md="2">
            <MudCard>
                <MudCardContent Class="text-center">
                    <MudText Typo="Typo.subtitle1">累计已付总额</MudText>
                    @* 修改点：Color="Color.Success" 控制文字颜色，而不是背景 *@
                    <MudText Typo="Typo.h5" Color="MudBlazor.Color.Success" Class="mud-font-bold">
                        @(_dashboardData?.TotalPaidAmount.ToString("¥#,##0.00"))
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        @* 5. 总欠付额 (橙色文字) *@
        <MudItem xs="12" sm="6" md="2">
            <MudCard>
                <MudCardContent Class="text-center">
                    <MudText Typo="Typo.subtitle1">总欠付额</MudText>
                    @* 修改点：Color="Color.Warning" 控制文字颜色 *@
                    <MudText Typo="Typo.h5" Color="MudBlazor.Color.Warning" Class="mud-font-bold">
                        @(_dashboardData?.TotalOutstandingAmount.ToString("¥#,##0.00"))
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    @* --- 区域二：图表与列表 --- *@
    <MudGrid Spacing="3" Class="mb-4">
        <!-- 左侧：柱状图 -->
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 100%;">
                <MudText Typo="Typo.h6" GutterBottom="true">合同金额 Top 5 项目</MudText>
                @if (_barChartSeries.Any())
                {
                    <MudChart ChartType="ChartType.Bar" ChartSeries="@_barChartSeries"
                              XAxisLabels="@_barChartXAxisLabels" Height="300px"
                              Width="100%"></MudChart>
                }
                else
                {
                    <MudText>暂无数据</MudText>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Spacing="3" Class="mb-4">
        <!-- 右侧：最新合同表格 -->
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4" Style="height: 100%;">
                <MudText Typo="Typo.h6" GutterBottom="true">最近签订的合同</MudText>
                <MudSimpleTable Dense="true" Hover="true">
                    <thead>
                    <tr>
                        <th>合同名称</th>
                        <th>所属项目</th>
                        <th>金额</th>
                        <th>签订日期</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var contract in _latestContracts)
                    {
                        <tr @onclick="@(() => NavigateToContract(contract))" style="cursor: pointer;">
                            <td>@contract.Name</td>
                            <td>@contract.Project.Name</td>
                            <td>@contract.ContractAmount.ToString("N2")</td>
                            <td>@contract.SigningDate?.ToString("yyyy-MM-dd")</td>
                        </tr>
                    }
                    </tbody>
                </MudSimpleTable>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    // 仪表盘数据模型
    public class DashboardData
    {
        public long ProjectCount { get; set; }
        public long ContractCount { get; set; }
        public decimal TotalContractAmount { get; set; }
        public decimal TotalPaidAmount { get; set; }
        public decimal TotalOutstandingAmount => TotalContractAmount - TotalPaidAmount;
    }

    private DashboardData? _dashboardData = new();
    private List<ContractDto> _latestContracts = new();

    // 图表数据
    private List<ChartSeries> _barChartSeries = new();
    private string[] _barChartXAxisLabels = Array.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            // 1. 获取项目总数 (MaxResultCount=1 为了最快返回只取总数，或者最好在 AppService 写个 Count 接口)
            var projectsResult = await _projectAppService.GetListAsync(new PagedAndSortedResultRequestDto { MaxResultCount = 1 });

            // 2. 获取所有合同 (为了计算金额，这里暂时全量拉取，生产环境建议后端聚合)
            // 注意：如果数据量大，这里必须改为专门的 GetDashboardStatsAsync 接口
            var allContractsResult = await _contractAppService.GetListAsync(new PagedAndSortedResultRequestDto { MaxResultCount = 1000 });
            var allContracts = allContractsResult.Items;

            // 3. 计算 KPI
            _dashboardData = new DashboardData
            {
                ProjectCount = projectsResult.TotalCount,
                ContractCount = allContractsResult.TotalCount,
                TotalContractAmount = allContracts.Sum(c => c.ContractAmount),
                TotalPaidAmount = allContracts.Sum(c => c.TotalPaidAmount)
            };

            // 4. 准备图表数据 (按项目分组统计合同额)
            var topProjects = allContracts
                .GroupBy(c => new { c.ProjectId, c.Project.Name })
                .Select(g => new
                {
                    Name = g.Key.Name ?? "未命名",
                    TotalAmount = g.Sum(c => c.ContractAmount)
                })
                .OrderByDescending(x => x.TotalAmount)
                .Take(5)
                .ToList();

            if (topProjects.Any())
            {
                _barChartSeries = new List<ChartSeries>
                {
                    new ChartSeries { Name = "合同金额", Data = topProjects.Select(p => (double)p.TotalAmount).ToArray() }
                };
                _barChartXAxisLabels = topProjects.Select(p => p.Name).ToArray();
            }

            // 5. 准备“最近签订”列表 (取前5条，按时间倒序)
            _latestContracts = allContracts
                .OrderByDescending(c => c.SigningDate ?? DateTime.MinValue)
                .Take(5)
                .ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载仪表盘失败: {ex.Message}", Severity.Error);
        }
    }

    private void NavigateToContract(ContractDto contract)
    {
        // 这里的路由可能需要根据你的 Contracts.razor 是否支持 QueryParameter 来调整
        // 假设 Contracts 页面还未支持 ?ProjectId=... 过滤，暂时只跳转到列表
        NavigationManager.NavigateTo("/projects/contracts");
    }
}